# roles/common/tasks/main.yml
- name: install vim sudo curl
  become: true
  apt:
    pkg: 
      - sudo
      - vim
      - curl
      - wget
      - gpg

- name: add apt key from elastic
  ansible.builtin.shell: "test -f /usr/share/keyrings/elastic.gpg || curl -fsSL https://artifacts.elastic.co/GPG-KEY-elasticsearch |sudo gpg --dearmor -o /usr/share/keyrings/elastic.gpg"

- name: add elastic repository
  become: true
  ansible.builtin.apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/elastic.gpg] https://artifacts.elastic.co/packages/7.x/apt stable main
    state: present

- name: install filebeat
  become: true
  apt:
    pkg: 
      - filebeat

- name: copy conf
  become: true
  ansible.builtin.copy:
    src: filebeat.yml
    dest: /etc/filebeat/filebeat.yml
    mode: 0644

- name: config vers logstash 1
  become: true
  ansible.builtin.command: filebeat modules enable system

- name: config vers logstash 2
  become: true
  ansible.builtin.command: sudo filebeat setup --pipelines --modules system

- name: config vers logstash 3
  become: true
  ansible.builtin.command: filebeat setup --index-management -E output.logstash.enabled=false -E 'output.elasticsearch.hosts=["10.32.70.3:9200"]'

- name: config vers logstash 4
  become: true
  ansible.builtin.command: filebeat setup -E output.logstash.enabled=false -E output.elasticsearch.hosts=['10.32.70.3:9200'] -E setup.kibana.host=10.32.70.3:5601

- name: restart filebeat
  become: true
  ansible.builtin.service:
    name: filebeat
    state: started
    enabled: true

# voir modules ansible apt 


# install glpi-agent
- name: copy agent to /tmp
  ansible.builtin.copy:
    src: glpi-agent-1.4-linux-installer.pl
    dest: /tmp/glpi-agent
    mode: 0755
 
- name: install glpi agent
  become: true
  ansible.builtin.command: perl /tmp/glpi-agent -S -s http://glpi.azeroth.wow/glpi/front/inventory.php --runnow


# exporter prometheus
# set sudoer
# set ssh key

#ssh-addkey.yml

- name: install ssh key
  become: true
  authorized_key: 
        user=mynthos
        key="{{ lookup('file', '/home/watchtower/ansible/roles/common/files/william.pub') }}" 
        state=present

- name: install ssh key
  become: true
  authorized_key: user=mynthos
                  key="{{ lookup('file', '/home/watchtower/ansible/roles/common/files/clement.pub') }}" 
                  state=present

- name: install ssh key
  become: true
  authorized_key: user=mynthos
                  key="{{ lookup('file', '/home/watchtower/ansible/roles/common/files/romaric.pub') }}" 
                  state=present
# set ntp
# install ca
- name: install ca
  become: true
  ansible.builtin.copy:
    src: /home/watchtower/ansible/roles/common/files/ca.crt
    dest: /usr/local/share/ca-certificates/gaston.medilab.crt

- name: update ca
  become: true
  ansible.builtin.command: update-ca-certificates

